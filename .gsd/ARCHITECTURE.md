# Architecture

> Auto-generated by /map on 2026-01-19

## Overview

Crispy Native is a high-performance media streaming application built with React Native and Expo, featuring a native Rust/Kotlin core for torrent streaming and high-fidelity video playback.

```
┌─────────────────────────────────────────┐
│           Expo / React Native UI        │
│    (Zustand, React Query, NativeWind)   │
├─────────────────────────────────────────┤
│        StreamingService (Bridge)        │
├─────────────────────────────────────────┤
│          Crispy Native Core             │
│   (jlibtorrent, NanoHTTPD, MpvPlayer)   │
└─────────────────────────────────────────┘
```

## Components

### Expo App (React Native)
- **Purpose:** UI, Routing, State Management, Metadata Enrichment.
- **Location:** `src/`
- **Dependencies:** `expo-router`, `zustand`, `react-query`, `nativewind`, `axios`.

### Crispy Native Core (Expo Module)
- **Purpose:** Torrent streaming engine, local HTTP server, native video player.
- **Location:** `modules/crispy-native-core/`
- **Dependencies:** `jlibtorrent`, `NanoHTTPD`, `androidx.lifecycle`, `kotlinx-coroutines`.

### TMDB Service
- **Purpose:** Enriches Stremio metadata with high-quality images, credits, and reviews from TMDB.
- **Location:** `src/core/api/TMDBService.ts`

### AI Service
- **Purpose:** Provides AI-powered insights and summaries for movies and shows.
- **Location:** `src/core/api/AIService.ts`
- **Provider:** OpenRouter.

### Addon Service
- **Purpose:** Interfaces with Stremio addons for catalogs and streams.
- **Location:** `src/core/api/AddonService.ts`

## Data Flow

1. **Discovery:** User browses catalogs (via `AddonService` and `TMDBService`).
2. **Resolution:** User selects a torrent stream (infoHash).
3. **Provisioning:** `StreamingService` passes infoHash to `CrispyNativeCore`.
4. **Streaming:** `CrispyNativeCore` (Kotlin/jlibtorrent) initializes the torrent, starts a local HTTP server (`CrispyServer` via `NanoHTTPD`), and returns a `http://127.0.0.1` stream URL.
5. **Playback:** `CrispyVideoView` (Mpv-based) receives the URL and begins playback.

## Integration Points

| Service | Type | Purpose |
|---------|------|---------|
| TMDB | REST API | Metadata, Images, Reviews |
| OpenRouter | REST API | AI Insights (DeepSeek R1) |
| Supabase | Backend as a Service | Auth, User Data Sync |
| Stremio Addons | HTTP Addon Protocol | Catalogs, Streams, Subtitles |

## Technical Debt

- [ ] **Testing:** No unit or integration tests found for core logic or native module.
- [ ] **Caching:** TMDB metadata caching is in-memory only and does not persist across sessions.
- [ ] **Config:** Some environment variables have insecure fallback values in source code.
- [ ] **Error Handling:** Minimal error boundaries in UI components.

## Conventions

**Naming:**
- PascalCase for React components and Services.
- camelCase for hooks and utility functions.
- kebab-case for some file names (e.g., `use-color-scheme.ts`).

**Structure:**
- Atomic component structure in `src/cdk` (Core Design Kit).
- Feature-based organization in `src/features`.
- Core logic and API layers in `src/core`.

**State Management:**
- Zustand for global application state.
- React Query for server-side state and caching.
- MMKV for high-performance key-value local persistence.
